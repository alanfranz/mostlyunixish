
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mostly Unixish</title>
  <meta name="author" content="Alan Franzoni">

  
  <meta name="description" content="UPDATED: 26th January 2015, with Tomcat 8 support. Today I&rsquo;m gonna share something that I figured out some times ago: how do I keep
my tomcat &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mostlyunixish.franzoni.eu/blog/page/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mostly Unixish" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32820324-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mostly Unixish</a></h1>
  
    <h2>tips & tricks, collected.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mostlyunixish.franzoni.eu" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a title="Go to my homepage" href="http://www.franzoni.eu">My homepage</a></li>
  <li><a title="Go to my software development blog" href="http://ollivander.franzoni.eu">Ollivander</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/03/keep-your-tomcat-instance-up-to-date-and-separate-configuration/">Keep Your Tomcat Instance Up-to-date, and Keep Apps and Configuration Tidy.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-03T19:52:00+02:00" pubdate data-updated="true">Sep 3<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>UPDATED:</strong> 26th January 2015, with Tomcat 8 support.</p>

<p>Today I&rsquo;m gonna share something that I figured out some times ago: how do I keep
my <a href="http://tomcat.apache.org">tomcat</a> installation up to date on my servers?</p>

<p>Of course I&rsquo;m not willing to automatically switch majors, but I&rsquo;d like to pull bugfix
releases in as soon as possible; most of my servers should work unattended, and I prefer
to handle it if something crashes rather than being hacked because of some public exploit.</p>

<p>Apache Tomcat makes it incredibly hard to do so for different reasons: first, there&rsquo;s no <em>latest</em>
link for the latest release, you must first check the homepage to see what&rsquo;s the latest version;
second, the archive you can download mingles the application itself with the configuration, log
and webapp dir.</p>

<p>What should we do, then?</p>

<p>Tomcat allows us to configure almost everything. Let&rsquo;s use its power!</p>

<p>For this setup, I use Tomcat7 and I chose to employ <em>/etc/tomcat7/conf</em> as a configuration directory, <em>/opt/tomcat7/latest</em> as tomcat7 own directory, <em>/opt/tomcat7/webapps</em> for our webapps, <em>/opt/tomcat7/logs</em>,
<em>/opt/tomcat7/temp</em>, <em>/opt/tomcat7/work</em> as logging, temp and work directory, respectively.</p>

<p>The same applies for tomcat8, it&rsquo;s just the prefix that will change.</p>

<p>To begin with, create a user (maybe a service user, I&rsquo;ll leave the details to you) <em>tomcat</em> with a main group <em>tomcat</em> as well, which we&rsquo;ll use to run the servlet container &ndash; you can pick a different user if you like, the class allows you to choose.</p>

<p>Now make sure your <a href="http://puppetlabs.com/">Puppet</a> manifest includes the <strong>tomcat_versioned</strong> class with the proper parameters. In order to do so, you&rsquo;ll need this custom fact that helps the system determine the very latest tomcat7 version,
place it in your custom facts directory:</p>

<figure class='code'><figcaption><span>find_apache_tomcat_latest_versions.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="c"># requires lxml</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">lxml.etree</span> <span class="kn">import</span> <span class="n">HTML</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">urllib</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
</span><span class='line'>  <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^{0}\.0\.\d\d\d?$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>
</span><span class='line'>  <span class="n">root</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://tomcat.apache.org/download-{0}0.cgi&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iterdescendants</span><span class="p">():</span>
</span><span class='line'>      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&quot;tomcat{1}_latest_version={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">version</span><span class="p">)</span>
</span><span class='line'>      <span class="k">break</span>
</span></code></pre></td></tr></table></div></figure>


<p>and the tomcat_versioned class, of course; just pass the major of the tomcat you&rsquo;d like to use, and it will find the latest tomcat update for such major, and install it in <em>/opt/tomcatX</em>:</p>

<figure class='code'><figcaption><span>tomcat_versioned.pp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="c-Singleline"># this will install latest tomcat from apache website, and yet retain your</span>
</span><span class='line'><span class="c-Singleline"># config from /etc/tomcat7/conf</span>
</span><span class='line'><span class="c-Singleline"># tested with puppet 3.7 and tomcat 7 and 8.</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">tomcat_versioned</span><span class="p">(</span><span class="nv">$tomcat_major</span><span class="p">=</span><span class="m">8</span><span class="p">,</span> <span class="nv">$tomcat_user</span><span class="p">=</span><span class="s2">&quot;tomcat&quot;</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'><span class="c-Singleline">   # assumption: the user should exist, it won&#39;t be created</span>
</span><span class='line'><span class="c-Singleline">   # you should define a tomcatX service outside this class</span>
</span><span class='line'>  <span class="nv">$tf</span> <span class="o">=</span> <span class="nf">getvar</span><span class="p">(</span><span class="s2">&quot;tomcat</span><span class="si">${tomcat_major}</span><span class="s2">_latest_version&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">$tm</span> <span class="o">=</span> <span class="s2">&quot;tomcat</span><span class="si">${tomcat_major}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">exec</span> <span class="p">{</span> <span class="s2">&quot;/bin/tar xvf apache-</span><span class="si">${tm}</span><span class="s2">-archive.tar.gz&quot;</span><span class="p">:</span>
</span><span class='line'>  <span class="nt">creates</span> <span class="p">=&gt;</span><span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">/apache-</span><span class="si">${tm}</span><span class="s2">-</span><span class="si">${tf}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">cwd</span> <span class="p">=&gt;</span> <span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">refreshonly</span> <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">alias</span> <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">_unpack&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">File</span><span class="p">[</span><span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">file</span> <span class="p">{</span> <span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="s2">&quot;directory&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">mode</span> <span class="p">=&gt;</span> <span class="m">0755</span><span class="p">,</span>
</span><span class='line'><span class="nt">owner</span> <span class="p">=&gt;</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">group</span> <span class="p">=&gt;</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nc">file</span> <span class="p">{</span> <span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">/apache-</span><span class="si">${tm}</span><span class="s2">-archive.tar.gz&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">ensure</span> <span class="p">=&gt;</span> <span class="s2">&quot;present&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">source</span> <span class="p">=&gt;</span> <span class="s2">&quot;/tmp/apache-tomcat-</span><span class="si">${tf}</span><span class="s2">.tar.gz&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">require</span> <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">_download_latest&quot;</span><span class="p">],</span>
</span><span class='line'><span class="nt">notify</span> <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">_unpack&quot;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">exec</span> <span class="p">{</span> <span class="s2">&quot;/usr/bin/wget --timestamping http://www.eu.apache.org/dist/tomcat/tomcat-</span><span class="si">${tomcat_major}</span><span class="s2">/v</span><span class="si">${tf}</span><span class="s2">/bin/apache-tomcat-</span><span class="si">${tf}</span><span class="s2">.tar.gz&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">alias</span> <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">_download_latest&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">cwd</span> <span class="p">=&gt;</span> <span class="s2">&quot;/tmp&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">exec</span> <span class="p">{</span> <span class="s2">&quot;/bin/ln -sf --no-target-directory apache-tomcat-</span><span class="si">${tf}</span><span class="s2"> latest&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">refreshonly</span> <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
</span><span class='line'><span class="nt">subscribe</span> <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">_unpack&quot;</span><span class="p">],</span>
</span><span class='line'><span class="nt">cwd</span> <span class="p">=&gt;</span> <span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">alias</span> <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">_symlink&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nc">exec</span> <span class="p">{</span> <span class="s2">&quot;/bin/rm -rf conf.orig &amp;&amp; /bin/mv -f conf conf.orig &amp;&amp; /bin/ln -sf --no-target-directory /etc/</span><span class="si">${tm}</span><span class="s2">/conf conf&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">refreshonly</span> <span class="p">=&gt;</span> <span class="ss">true</span><span class="p">,</span>
</span><span class='line'><span class="nt">cwd</span> <span class="p">=&gt;</span> <span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">/latest&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">subscribe</span> <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">_symlink&quot;</span><span class="p">],</span>
</span><span class='line'><span class="nt">notify</span> <span class="p">=&gt;</span> <span class="nc">Service</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">&quot;</span><span class="p">],</span>
</span><span class='line'><span class="nt">alias</span> <span class="p">=&gt;</span> <span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">_config_move&quot;</span>
</span><span class='line'><span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># first-time only executions. I might like to abstract some logic if I were a bit less lazy than I am.</span>
</span><span class='line'><span class="c-Singleline"># in order to stay on the safe side, we never let the normal user to access our files; this may be relaxed,</span>
</span><span class='line'><span class="c-Singleline"># depending on your context.</span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># this contains our config. our servlet container should be able to read it, but never write it.</span>
</span><span class='line'><span class="nc">exec</span> <span class="p">{</span> <span class="s2">&quot;/bin/mkdir -p /etc/</span><span class="si">${tm}</span><span class="s2"> &amp;&amp; /bin/cp -r /opt/</span><span class="si">${tm}</span><span class="s2">/latest/conf.orig /etc/</span><span class="si">${tm}</span><span class="s2">/conf &amp;&amp; /bin/chmod 0750 /etc/</span><span class="si">${tm}</span><span class="s2">/conf &amp;&amp; /bin/chown -R root:</span><span class="si">${tomcat_user}</span><span class="s2"> /etc/</span><span class="si">${tm}</span><span class="s2">/conf &amp;&amp; /bin/chmod 0640 /etc/</span><span class="si">${tm}</span><span class="s2">/conf/*&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">creates</span> <span class="p">=&gt;</span> <span class="s2">&quot;/etc/</span><span class="si">${tm}</span><span class="s2">/conf&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">subscribe</span> <span class="p">=&gt;</span> <span class="nc">Exec</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">${tm}</span><span class="s2">_config_move&quot;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># this will contain the actual code of our webapps. Again, the container must be able to read them,</span>
</span><span class='line'><span class="c-Singleline"># never write to them.</span>
</span><span class='line'><span class="nc">exec</span> <span class="p">{</span> <span class="s2">&quot;/bin/mkdir -p -m 0750 /opt/</span><span class="si">${tm}</span><span class="s2">/webapps &amp;&amp; /bin/chown root:</span><span class="si">${tomcat_user}</span><span class="s2"> /opt/</span><span class="si">${tm}</span><span class="s2">/webapps&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">creates</span> <span class="p">=&gt;</span> <span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">/webapps&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline"># those are working directories where the container must be able to write.</span>
</span><span class='line'><span class="nc">exec</span> <span class="p">{</span> <span class="s2">&quot;/bin/mkdir -p -m 0770 /opt/</span><span class="si">${tm}</span><span class="s2">/work &amp;&amp; /bin/chown root:</span><span class="si">${tomcat_user}</span><span class="s2"> /opt/</span><span class="si">${tm}</span><span class="s2">/work&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">creates</span> <span class="p">=&gt;</span> <span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">/work&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">exec</span> <span class="p">{</span> <span class="s2">&quot;/bin/mkdir -p -m 0770 /opt/</span><span class="si">${tm}</span><span class="s2">/temp &amp;&amp; /bin/chown root:</span><span class="si">${tomcat_user}</span><span class="s2"> /opt/</span><span class="si">${tm}</span><span class="s2">/temp&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">creates</span> <span class="p">=&gt;</span> <span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">/temp&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">exec</span> <span class="p">{</span> <span class="s2">&quot;/bin/mkdir -p -m 0770 /opt/</span><span class="si">${tm}</span><span class="s2">/logs &amp;&amp; /bin/chown root:</span><span class="si">${tomcat_user}</span><span class="s2"> /opt/</span><span class="si">${tm}</span><span class="s2">/logs&quot;</span><span class="p">:</span>
</span><span class='line'><span class="nt">creates</span> <span class="p">=&gt;</span> <span class="s2">&quot;/opt/</span><span class="si">${tm}</span><span class="s2">/logs&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>The tomcat7 service is trivial and omitted, fill it in by yourself (or delete it).</p>

<p>Once this is done, you&rsquo;ll find a base configuration in <em>/etc/tomcat7/conf</em>. We must now edit <em>server.xml</em> there and tell Tomcat where we&rsquo;d like to have our webapps, logs and work directories:</p>

<figure class='code'><figcaption><span>server.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="c">&lt;!-- this should go inside &lt;Server&gt;&lt;Service&gt;&lt;Engine&gt; --&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;Host</span> <span class="na">name=</span><span class="s">&quot;localhost&quot;</span>  <span class="na">appBase=</span><span class="s">&quot;/opt/tomcat7/webapps&quot;</span>
</span><span class='line'>            <span class="na">unpackWARs=</span><span class="s">&quot;false&quot;</span> <span class="na">autoDeploy=</span><span class="s">&quot;true&quot;</span> <span class="na">workDir=</span><span class="s">&quot;/opt/tomcat7/work&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c">&lt;!-- SingleSignOn valve, share authentication between web applications</span>
</span><span class='line'><span class="c">             Documentation at: /docs/config/valve.html --&gt;</span>
</span><span class='line'>        <span class="c">&lt;!--</span>
</span><span class='line'><span class="c">        &lt;Valve className=&quot;org.apache.catalina.authenticator.SingleSignOn&quot; /&gt;</span>
</span><span class='line'><span class="c">        --&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c">&lt;!-- Access log processes all example.</span>
</span><span class='line'><span class="c">             Documentation at: /docs/config/valve.html</span>
</span><span class='line'><span class="c">             Note: The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="na">directory=</span><span class="s">&quot;/opt/tomcat7/logs&quot;</span>
</span><span class='line'>               <span class="na">prefix=</span><span class="s">&quot;localhost_access_log.&quot;</span> <span class="na">suffix=</span><span class="s">&quot;.txt&quot;</span>
</span><span class='line'>               <span class="na">pattern=</span><span class="s">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&lt;/Host&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last but not least, we should tell tomcat what is <em>CATALINA_HOME</em> and <em>CATALINA_TMPDIR</em>. This is an example script that can be used with upstart on Ubuntu 12.04, change it according to your OS:</p>

<figure class='code'><figcaption><span>tomcat7.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>description &quot;tomcat7&quot;
</span><span class='line'>
</span><span class='line'>  start on runlevel [2345]
</span><span class='line'>  stop on runlevel [!2345]
</span><span class='line'>  respawn
</span><span class='line'>  respawn limit 10 5
</span><span class='line'>
</span><span class='line'>  # run as non privileged user
</span><span class='line'>  # add user with this command:
</span><span class='line'>  ## adduser --system --ingroup www-data --home /opt/apache-tomcat apache-tomcat
</span><span class='line'>  # Ubuntu 12.04: (use &#39;exec sudo -u apache-tomcat&#39; when using 10.04)
</span><span class='line'>  setuid tomcat
</span><span class='line'>  setgid tomcat
</span><span class='line'>
</span><span class='line'>  # adapt paths:
</span><span class='line'>  env JAVA_HOME=/usr/lib/jvm/java-7-oracle
</span><span class='line'>  env CATALINA_HOME=/opt/tomcat7/latest
</span><span class='line'>  env CATALINA_TMPDIR=/opt/tomcat7/temp
</span><span class='line'>  env HOME=/home/tomcat
</span><span class='line'>
</span><span class='line'>  # adapt java options to suit your needs:
</span><span class='line'>  env JAVA_OPTS=&quot;-Djava.awt.headless=true&quot;
</span><span class='line'>  env CATALINA_OPTS=&quot;-Xmx1536M -server&quot;
</span><span class='line'>
</span><span class='line'>  exec $CATALINA_HOME/bin/catalina.sh run
</span><span class='line'>
</span><span class='line'>  # cleanup temp directory after stop
</span><span class='line'>  post-stop script
</span><span class='line'>    rm -rf /opt/tomcat7/temp/*
</span><span class='line'>  end script
</span></code></pre></td></tr></table></div></figure>


<p>In this situation I had a &ldquo;normal home&rdquo; for tomcat because I needed it, but your requirements
may work differently.</p>

<p>I hope that&rsquo;s useful to somebody.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/12/puppet-http-source-for-files/">Puppet Http Source for Files</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-12T13:59:00+01:00" pubdate data-updated="true">Nov 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes you would like to use an http URL as the source file for <a href="http://puppetlabs.com/">puppet</a>; while it&rsquo;s being discussed
<a href="http://projects.puppetlabs.com/issues/5783">since long</a>, no implementation has been created so far.</p>

<p>Of course it would be better to periodically download the file from its http source to the puppet master,
and then use puppet file server to send such file to our client; but that&rsquo;s impractical in some contexts, especially
if you&rsquo;re using your puppet in headless mode, i.e. without a master. In such situations you may <strong>really</strong> want to
source files from http, <strong>without</strong> redownloading them if they haven&rsquo;t changed.</p>

<p>I found a good way to do it is to use the excellent <a href="http://www.gnu.org/software/wget/">wget</a> command line tool.</p>

<p>This is an example of what I use to keep my installation of <a href="http://www.jenkins-ci.org">Jenkins</a> up to date:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>class jenkins {
</span><span class='line'>  exec { "/usr/bin/wget --timestamping http://mirrors.jenkins-ci.org/war-stable/latest/jenkins.war":
</span><span class='line'>      alias =&gt; "jenkinslatest",
</span><span class='line'>      cwd =&gt; "/tmp",
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  file { "/opt/tomcat7/latest/webapps/jenkins.war":
</span><span class='line'>      ensure =&gt; present,
</span><span class='line'>      source =&gt; "/tmp/jenkins.war",
</span><span class='line'>      alias =&gt; "jenkinswar",
</span><span class='line'>      require =&gt; Exec["jenkinslatest"] }
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>The <em>timestamping</em> flag will let wget check the remote server for file modification time; if file hasn&rsquo;t changed,
it won&rsquo;t be redownloaded.</p>

<p>Just choose a proper directory for temporary downloads (tmp is volatile and gets sometimes cleaned up at runtime as well),
make sure the server properly sets the Last-Modified header and remember to refresh your other resources when files change,
and you&rsquo;re done.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/08/quick-log-for-bash-scripts/">Quick Log for Bash Scripts, With Line Limit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-08T21:18:00+02:00" pubdate data-updated="true">Oct 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes you need to write a quick shell script; many a time, you need to put it on a server,
and launch it every now and then, or run it in a cron job. That script may end up doing something
important and/or altering the state of the server machine.</p>

<p>If that script starts being using often enough, you&rsquo;ll want logging as well, and that can be
a complex beast to tame, for logs require rotation and deletion, otherwise the beast will eat up
all your disk space. Setting up <a href="http://linuxcommand.org/man_pages/logrotate8.html">logrotate</a> for a
single shell script looks like an overkill to me most of the times.</p>

<p>So what? Many a times logging will be neglected, and you&rsquo;ll lose the ability to track what happened
and why.</p>

<p>This is my quick recipe for a basic bash logging solution with line-based truncation: the logfile
will never exceed <strong>RETAIN_NUM_LINES</strong> lines (actually, it will never exceed such size when the script
is launched, so the number of lines when the script has run is RETAIN_NUM_LINES + number of lines logged by
the script).</p>

<p>Whenever you use the <em>log</em> function you&rsquo;ll get output on stdout as well, complete with a timestamp.</p>

<figure class='code'><figcaption><span> (quicklog.sh)</span> <a href='/downloads/code/quicklog.sh'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># set LOGFILE to the full path of your desired logfile; make sure</span>
</span><span class='line'><span class="c"># you have write permissions there. set RETAIN_NUM_LINES to the</span>
</span><span class='line'><span class="c"># maximum number of lines that should be retained at the beginning</span>
</span><span class='line'><span class="c"># of your program execution.</span>
</span><span class='line'><span class="c"># execute &#39;logsetup&#39; once at the beginning of your script, then </span>
</span><span class='line'><span class="c"># use &#39;log&#39; how many times you like.</span>
</span><span class='line'>
</span><span class='line'><span class="nv">LOGFILE</span><span class="o">=</span>quicklog.sh.log
</span><span class='line'><span class="nv">RETAIN_NUM_LINES</span><span class="o">=</span>10
</span><span class='line'>
</span><span class='line'><span class="k">function </span>logsetup <span class="o">{</span>
</span><span class='line'>    <span class="nv">TMP</span><span class="o">=</span><span class="k">$(</span>tail -n <span class="nv">$RETAIN_NUM_LINES</span> <span class="nv">$LOGFILE</span> 2&gt;/dev/null<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;${TMP}&quot;</span> &gt; <span class="nv">$LOGFILE</span>
</span><span class='line'>    <span class="nb">exec</span> &gt; &gt;<span class="o">(</span>tee -a <span class="nv">$LOGFILE</span><span class="o">)</span>
</span><span class='line'>    <span class="nb">exec </span>2&gt;&amp;1
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function </span>log <span class="o">{</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;[$(date)]: $*&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>logsetup
</span><span class='line'>
</span><span class='line'>log hello this is a log
</span></code></pre></td></tr></table></div></figure>


<p>Launch this a lot of times and you&rsquo;ll end up with this:</p>

<figure class='code'><figcaption><span> (quicklog.sh.log)</span> <a href='/downloads/code/quicklog.sh.log'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[Tue Oct  8 20:57:49 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:49 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:50 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:50 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:50 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:50 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:51 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:51 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:51 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:51 CEST 2013]: hello this is a log
</span><span class='line'>[Tue Oct  8 20:57:52 CEST 2013]: hello this is a log
</span></code></pre></td></tr></table></div></figure>


<p>Enjoy!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/16/kill-me-softly/">Kill Me Softly: killing a process the right way</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/12/unfreeze-window-manager/">Unfreezing your desktop: when Compiz goes wrong</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/11/su-with-chosen-shell/">Don&#8217;t give a shell to system users - use su</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/10/ssh-hostname-shortcuts/">SSH Hostnames configuration and shortcuts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/11/how-often-sudo-asks-for-your-password/">I wish sudo would ask for my password less often</a>
      </li>
    
  </ul>
</section>




<section>
  <h1>Latest Tweets</h1>
  <a class="twitter-timeline" href="https://twitter.com/franzeur" data-widget-id="361445337954672640">Tweets by @franzeur</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Alan Franzoni -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mostlyunixish';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
